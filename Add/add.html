<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê¸°ë¡ ì¶”ê°€/ìˆ˜ì •í•˜ê¸°</title>
  <link rel="stylesheet" href="add.css" />
  <style>
    /* ì´ëª¨ì§€ í”½ì»¤ ìµœì†Œ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ê³¼ ë™ì¼) */
    .emoji-picker {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 8px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px;
      display: none;
      flex-wrap: wrap;
      gap: 8px;
      max-width: 300px;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 100;
    }
    .emoji-option {
      cursor: pointer;
      font-size: 20px;
    }
    .emoji-section {
      position: relative;
    }
  </style>
</head>
<body>
  <div class="mobile-wrapper">
    <div class="top-bar">
      <img
        src="../images/iconoir_nav-arrow-left.png"
        class="back-icon"
        onclick="history.back()"
      />
      <span class="page-title" id="page-title">ì§€ì—­</span>
    </div>

    <div class="form">
      <!-- 1) ì œëª© ì…ë ¥ -->
      <input type="text" id="title-input" class="title-underline" placeholder="ì œëª©: ex. 2025 ê°€ì¡±ì—¬í–‰" />

      <!-- 2) ì§€ì—­ ì„ íƒ ì¹© -->
      <div class="region-group">
        <div class="region-chip base" id="base-chip">ì§€ì—­</div>
        <button class="add-region" id="add-region-btn">+ ì§€ì—­ ì¶”ê°€í•˜ê¸°</button>
      </div>

      <!-- 3) ì‚¬ì§„ ì—…ë¡œë“œ & ìŠ¬ë¼ì´ë” -->
      <div class="photo-box">
        <div class="photo-placeholder" id="photo-placeholder">
          <img src="../images/Group.svg" alt="ì‚¬ì§„ ì•„ì´ì½˜" />
          <button type="button" class="photo-button" id="photo-add-btn">ì‚¬ì§„ ì¶”ê°€í•˜ê¸°</button>
          <p>ê¸°ì–µì— ë‚¨ëŠ” ìˆœê°„ì„ ì¶”ê°€í•˜ì„¸ìš”!</p>
        </div>
        <input type="file" id="photo-input" accept="image/*" multiple style="display: none;" />
        <div id="photo-slider" class="photo-slider" style="display: none;"></div>
      </div>

      <!-- 4) ì´ëª¨ì§€ ì„ íƒ ì„¹ì…˜ -->
      <div class="emoji-section">
        <button class="add-emoji" aria-label="ì´ëª¨ì§€ ì¶”ê°€" id="emoji-toggle">
          <img src="../images/Button-Icon.svg" alt="ì´ëª¨ì§€ ì¶”ê°€" class="emoji-icon" id="emoji-display" />
        </button>
        <div class="emoji-picker" id="emoji-picker">
          <span class="emoji-option">ğŸŒ</span><span class="emoji-option">ğŸŒ„</span><span class="emoji-option">âœˆï¸</span>
          <span class="emoji-option">ğŸ¨</span><span class="emoji-option">ğŸŒ‡</span><span class="emoji-option">ğŸ›³ï¸</span>
          <span class="emoji-option">ğŸš—</span><span class="emoji-option">ğŸš¤</span><span class="emoji-option">ğŸš©</span>
          <span class="emoji-option">ğŸŒ</span><span class="emoji-option">ğŸŒŠ</span><span class="emoji-option">ğŸŒ¿</span>
          <span class="emoji-option">ğŸœ</span><span class="emoji-option">ğŸ”</span><span class="emoji-option">ğŸ½ï¸</span>
          <span class="emoji-option">ğŸ·</span><span class="emoji-option">ğŸ³</span><span class="emoji-option">ğŸ¦</span>
          <span class="emoji-option">ğŸ’ƒ</span><span class="emoji-option">ğŸ‘¯</span><span class="emoji-option">ğŸ‘®</span>
          <span class="emoji-option">ğŸ˜</span><span class="emoji-option">ğŸ˜</span><span class="emoji-option">ğŸ˜Š</span>
          <span class="emoji-option">ğŸ˜</span><span class="emoji-option">ğŸ¤£</span><span class="emoji-option">ğŸ˜‚</span>
          <span class="emoji-option">ğŸ˜˜</span><span class="emoji-option">ğŸ˜­</span><span class="emoji-option">ğŸ˜³</span>
          <span class="emoji-option">ğŸ˜†</span><span class="emoji-option">ğŸ˜‡</span><span class="emoji-option">ğŸ˜‹</span>
          <span class="emoji-option">ğŸ˜Œ</span><span class="emoji-option">ğŸ˜œ</span><span class="emoji-option">ğŸ˜</span>
          <span class="emoji-option">ğŸ˜›</span><span class="emoji-option">ğŸ˜¢</span><span class="emoji-option">ğŸ˜¡</span>
          <span class="emoji-option">ğŸ˜±</span><span class="emoji-option">ğŸ˜¤</span><span class="emoji-option">ğŸ˜·</span>
          <span class="emoji-option">ğŸ¤’</span><span class="emoji-option">ğŸ¤•</span><span class="emoji-option">ğŸ¤¢</span>
          <span class="emoji-option">ğŸ¤§</span><span class="emoji-option">ğŸ¥¶</span><span class="emoji-option">ğŸ¥µ</span>
          <span class="emoji-option">ğŸ¥³</span><span class="emoji-option">ğŸ˜¬</span><span class="emoji-option">ğŸ˜</span>
          <span class="emoji-option">ğŸ˜¶</span><span class="emoji-option">ğŸ™„</span><span class="emoji-option">ğŸ˜¯</span>
          <span class="emoji-option">ğŸ˜²</span><span class="emoji-option">ğŸ˜´</span><span class="emoji-option">ğŸ˜ª</span>
          <span class="emoji-option">ğŸ˜µ</span><span class="emoji-option">ğŸ¤¯</span><span class="emoji-option">ğŸ¤ </span>
          <span class="emoji-option">ğŸ¥´</span><span class="emoji-option">ğŸ¤“</span><span class="emoji-option">ğŸ§</span>
          <span class="emoji-option">ğŸ¤¨</span><span class="emoji-option">ğŸ˜”</span><span class="emoji-option">ğŸ˜–</span>
          <span class="emoji-option">ğŸ˜</span><span class="emoji-option">ğŸ˜Ÿ</span><span class="emoji-option">ğŸ˜£</span>
          <span class="emoji-option">ğŸ˜«</span><span class="emoji-option">ğŸ˜©</span><span class="emoji-option">ğŸ˜“</span>
          <span class="emoji-option">ğŸ˜¥</span><span class="emoji-option">ğŸ˜°</span><span class="emoji-option">ğŸ¤¤</span>
          <span class="emoji-option">ğŸ˜¢</span><span class="emoji-option">ğŸ˜­</span><span class="emoji-option">ğŸ˜¤</span>
          <span class="emoji-option">ğŸ¤¬</span><span class="emoji-option">ğŸ˜ </span><span class="emoji-option">ğŸ˜¡</span>
          <span class="emoji-option">ğŸ˜‡</span><span class="emoji-option">ğŸ˜·</span><span class="emoji-option">ğŸ¤’</span>
          <span class="emoji-option">ğŸ¤•</span><span class="emoji-option">ğŸ¤¢</span><span class="emoji-option">ğŸ¤§</span>
          <span class="emoji-option">ğŸ¥µ</span><span class="emoji-option">ğŸ¥¶</span><span class="emoji-option">ğŸ¥´</span>
          <span class="emoji-option">ğŸ¤ </span><span class="emoji-option">ğŸ˜ˆ</span><span class="emoji-option">ğŸ‘¹</span>
          <span class="emoji-option">ğŸ‘º</span><span class="emoji-option">ğŸ’€</span><span class="emoji-option">ğŸ‘»</span>
          <span class="emoji-option">ğŸ‘½</span><span class="emoji-option">ğŸ¤–</span><span class="emoji-option">ğŸƒ</span>
          <span class="emoji-option">ğŸ˜º</span><span class="emoji-option">ğŸ˜¸</span><span class="emoji-option">ğŸ˜¹</span>
          <span class="emoji-option">ğŸ˜»</span><span class="emoji-option">ğŸ˜¼</span><span class="emoji-option">ğŸ˜½</span>
          <span class="emoji-option">ğŸ™€</span><span class="emoji-option">ğŸ˜¿</span><span class="emoji-option">ğŸ˜¾</span>
          <span class="emoji-option">ğŸ™ˆ</span><span class="emoji-option">ğŸ™‰</span><span class="emoji-option">ğŸ™Š</span>
          <span class="emoji-option">ğŸ’‹</span><span class="emoji-option">ğŸ’Œ</span><span class="emoji-option">ğŸ’˜</span>
          <span class="emoji-option">ğŸ’</span><span class="emoji-option">ğŸ’–</span><span class="emoji-option">ğŸ’—</span>
          <span class="emoji-option">ğŸ’“</span><span class="emoji-option">ğŸ’</span><span class="emoji-option">ğŸ’•</span>
          <span class="emoji-option">ğŸ’Ÿ</span><span class="emoji-option">â£ï¸</span><span class="emoji-option">â¤ï¸</span>
          <span class="emoji-option">ğŸ§¡</span><span class="emoji-option">ğŸ’›</span><span class="emoji-option">ğŸ’š</span>
          <span class="emoji-option">ğŸ’™</span><span class="emoji-option">ğŸ’œ</span><span class="emoji-option">ğŸ–¤</span>
          <span class="emoji-option">ğŸ¤</span><span class="emoji-option">ğŸ¤</span><span class="emoji-option">â¤ï¸â€ğŸ”¥</span>
          <span class="emoji-option">â¤ï¸â€ğŸ©¹</span><span class="emoji-option">ğŸ’¯</span><span class="emoji-option">ğŸ’¢</span>
          <span class="emoji-option">ğŸ’¥</span><span class="emoji-option">ğŸ’«</span><span class="emoji-option">ğŸ’¦</span>
          <span class="emoji-option">ğŸ’¨</span><span class="emoji-option">ğŸ•³ï¸</span><span class="emoji-option">ğŸ’£</span>
          <span class="emoji-option">ğŸ’¬</span><span class="emoji-option">ğŸ—¯ï¸</span><span class="emoji-option">ğŸ’­</span>
          <span class="emoji-option">ğŸ—¨ï¸</span><span class="emoji-option">ğŸ•¶ï¸</span><span class="emoji-option">ğŸ‘’</span>
          <span class="emoji-option">ğŸ©</span><span class="emoji-option">ğŸ‘‘</span><span class="emoji-option">â›‘ï¸</span>
          <span class="emoji-option">ğŸ’</span><span class="emoji-option">ğŸ‘</span><span class="emoji-option">ğŸ‘›</span>
          <span class="emoji-option">ğŸ‘œ</span><span class="emoji-option">ğŸ’¼</span><span class="emoji-option">ğŸ“</span>
          <span class="emoji-option">ğŸ§³</span><span class="emoji-option">ğŸ§¢</span><span class="emoji-option">ğŸ¥¾</span>
        </div>
        <div class="emoji-guide">ì•„ì´ì½˜ì„ ì¶”ê°€í•´ ë³´ì„¸ìš”.</div>
      </div>

      <!-- 5) ë©”ëª¨ -->
      <textarea class="memo" id="memo-input" placeholder="ê·¸ ë•Œì˜ ê¸°ì–µì„ ë˜ì§šì–´ë³´ë©° ê¸°ë¡í•´ ë³´ì„¸ìš”."></textarea>

      <!-- 6) ë²„íŠ¼: ì„ì‹œì €ì¥, ì €ì¥í•˜ê¸° -->
      <button class="temp-save" id="temp-save-btn">ì„ì‹œì €ì¥</button>
      <button class="save-button" id="save-btn">ì €ì¥í•˜ê¸°</button>
    </div>
  </div>

  <script>
    // -- 0. URL íŒŒë¼ë¯¸í„° ì½ê¸° ë° ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ --
    const params = new URLSearchParams(window.location.search);
    let regionParam = params.get("region") || "ì§€ì—­";
    const postIdParam = params.get("postId");
    const editIndex = params.get("edit"); // ì„ì‹œí¸ì§‘ ì¸ë±ìŠ¤

    const pageTitleEl = document.getElementById("page-title");
    const baseChipEl = document.getElementById("base-chip");
    const regionGroupEl = document.querySelector(".region-group");
    const addRegionBtn = document.getElementById("add-region-btn");

    const titleInput = document.getElementById("title-input");
    const photoInput = document.getElementById("photo-input");
    const photoPlaceholder = document.getElementById("photo-placeholder");
    const photoSlider = document.getElementById("photo-slider");
    const photoAddBtn = document.getElementById("photo-add-btn");

    const emojiToggle = document.getElementById("emoji-toggle");
    const emojiPicker = document.getElementById("emoji-picker");
    const emojiDisplay = document.getElementById("emoji-display");

    const memoInput = document.getElementById("memo-input");
    const tempSaveBtn = document.getElementById("temp-save-btn");
    const saveBtn = document.getElementById("save-btn");

    let selectedDistricts = [];   // ì„¸ë¶€ ì§€ì—­ ë°°ì—´
    let existingPhotos = [];       // ì‚¬ì§„ ë°ì´í„° URL ë°°ì—´
    let currentEmoji = "";         // ì´ëª¨ì§€
    let restoredFromStorage = false;

    // -- 1. ìƒìœ„ ì§€ì—­(ì¹´í…Œê³ ë¦¬) ì„¤ì • (regionParam) --
    pageTitleEl.textContent = regionParam;
    baseChipEl.textContent = regionParam;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // -- 2. ì„¸ë¶€ ì§€ì—­(ì¹©) ë Œë”ë§ í•¨ìˆ˜ --
    function renderDistrictChips() {
      regionGroupEl.querySelectorAll(".region-chip.sub").forEach(el => el.remove());
      selectedDistricts.forEach(district => {
        const tag = document.createElement("div");
        tag.className = "region-chip sub";
        const textSpan = document.createElement("span");
        textSpan.textContent = district;
        const removeIcon = document.createElement("span");
        removeIcon.className = "remove-chip";
        removeIcon.innerHTML = "&times;";
        removeIcon.onclick = (e) => {
          e.stopPropagation();
          selectedDistricts = selectedDistricts.filter(d => d !== district);
          renderDistrictChips();
        };
        tag.appendChild(textSpan);
        tag.appendChild(removeIcon);
        regionGroupEl.insertBefore(tag, addRegionBtn);
      });
      addRegionBtn.style.display = selectedDistricts.length >= 4 ? "none" : "inline-flex";
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // -- 3. localStorage ë³µì› ì½”ë“œ (ì„ì‹œ ì €ì¥ ì¤‘ê°„ ë‹¨ê³„ ë³µì›) --
    {
      // (A) regionâ€select.html â†’ add.html (ìƒì„¸í¸ì§‘ ì•„ë‹˜) ë³µì›
      const fromSelected = JSON.parse(localStorage.getItem("selectedDistricts") || "null");
      if (fromSelected && Array.isArray(fromSelected)) {
        selectedDistricts = fromSelected.slice(0, 4);
        localStorage.removeItem("selectedDistricts");
        renderDistrictChips();
        restoredFromStorage = true;
      } else {
        // (B) temp ë³µì› (add.html í´ë¦­ ì´í›„ ëŒì•„ì˜¬ ë•Œ)
        const fromTemp = JSON.parse(localStorage.getItem("tempDistricts") || "null");
        if (fromTemp && Array.isArray(fromTemp)) {
          selectedDistricts = fromTemp.slice(0, 4);
          localStorage.removeItem("tempDistricts");
          renderDistrictChips();
          restoredFromStorage = true;
        }
      }

      // ì‚¬ì§„ ë³µì›
      const savedPhotos = JSON.parse(localStorage.getItem("tempPhotos") || "null");
      if (savedPhotos && Array.isArray(savedPhotos) && savedPhotos.length > 0) {
        existingPhotos = savedPhotos;
        renderPhotos(existingPhotos);
        localStorage.removeItem("tempPhotos");
        restoredFromStorage = true;
      }

      // ì œëª© ë³µì›
      const savedTitle = localStorage.getItem("tempTitle");
      if (savedTitle !== null) {
        titleInput.value = savedTitle;
        localStorage.removeItem("tempTitle");
        restoredFromStorage = true;
      }

      // ì´ëª¨ì§€ ë³µì›
      const savedEmoji = localStorage.getItem("tempEmoji");
      if (savedEmoji) {
        currentEmoji = savedEmoji;
        const span = document.createElement("span");
        span.className = "emoji-icon";
        span.textContent = currentEmoji;
        const existing = document.querySelector("#emoji-toggle .emoji-icon, #emoji-toggle img");
        if (existing) existing.replaceWith(span);
        localStorage.removeItem("tempEmoji");
        restoredFromStorage = true;
      }

      // ë©”ëª¨ ë³µì›
      const savedMemo = localStorage.getItem("tempMemo");
      if (savedMemo !== null) {
        memoInput.value = savedMemo;
        localStorage.removeItem("tempMemo");
        restoredFromStorage = true;
      }
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // -- 4. â€œì •ì‹ ì €ì¥ëœâ€ ìˆ˜ì • ëª¨ë“œ(postIdParam) ë˜ëŠ” â€œì„ì‹œ ì €ì¥ëœâ€ ìˆ˜ì • ëª¨ë“œ(editIndex) ì²˜ë¦¬ --
    if (postIdParam) {
      // ê¸°ì¡´ posts ë°ì´í„°ì—ì„œ ì°¾ì•„ì„œ ë Œë”
      const allPosts = JSON.parse(localStorage.getItem("posts") || "[]");
      const targetPost = allPosts.find(p => p.id === postIdParam);
      if (targetPost) {
        // 4-1) regionParam, ì œëª©, íƒœê·¸, ì‚¬ì§„, ì´ëª¨ì§€, ë©”ëª¨ ëª¨ë‘ ë¶ˆëŸ¬ì˜¤ê¸°
        regionParam = targetPost.region;
        pageTitleEl.textContent = regionParam;
        baseChipEl.textContent = regionParam;

        titleInput.value = targetPost.title;
        selectedDistricts = [...targetPost.districts];
        existingPhotos = [...targetPost.photos];
        renderDistrictChips();
        if (existingPhotos.length) renderPhotos(existingPhotos);

        currentEmoji = targetPost.emoji || "";
        if (currentEmoji) {
          emojiDisplay.replaceWith(
            Object.assign(document.createElement("span"), {
              className: "emoji-icon",
              textContent: currentEmoji,
              id: "emoji-display"
            })
          );
        }

        memoInput.value = targetPost.memo;
      }
    } else if (editIndex !== null) {
      // 4-2) ì„ì‹œì €ì¥ëœ ë°ì´í„°(editRecord) ë³µì›
      const tempData = JSON.parse(localStorage.getItem("editRecord") || "null");
      if (tempData) {
        // tempData êµ¬ì¡°: { region, title, tags, photos, emoji, memo } 
        // (ì˜›ë‚  ë²„ì „ì—” { region, title, tags, image, emoji } í˜•íƒœì¼ ìˆ˜ ìˆìŒ)

        // --- ìƒìœ„ ì§€ì—­ ë³µì› ---
        regionParam = tempData.region || regionParam;
        pageTitleEl.textContent = regionParam;
        baseChipEl.textContent = regionParam;

        // --- ì œëª© ë³µì› ---
        titleInput.value = tempData.title || "";

        // --- ì„¸ë¶€ ì§€ì—­(tags) ë³µì› ---
        selectedDistricts = Array.isArray(tempData.tags) ? [...tempData.tags] : [];
        renderDistrictChips();

        // --- ì‚¬ì§„ ë³µì› (photos ë°°ì—´ ìš°ì„ , ì—†ìœ¼ë©´ ì˜ˆì „ image í•˜ë‚˜ë¡œ ì²˜ë¦¬) ---
        if (Array.isArray(tempData.photos) && tempData.photos.length > 0) {
          existingPhotos = [...tempData.photos];
        } else if (typeof tempData.image === "string" && tempData.image) {
          // êµ¬ ë²„ì „ì—ì„œ imageë§Œ ì €ì¥í–ˆì„ ë•Œ
          existingPhotos = [tempData.image];
        } else {
          existingPhotos = [];
        }
        if (existingPhotos.length) renderPhotos(existingPhotos);

        // --- ì´ëª¨ì§€ ë³µì› ---
        currentEmoji = tempData.emoji || "";
        if (currentEmoji) {
          emojiDisplay.replaceWith(
            Object.assign(document.createElement("span"), {
              className: "emoji-icon",
              textContent: currentEmoji,
              id: "emoji-display"
            })
          );
        }

        // --- ë©”ëª¨ ë³µì› ---
        memoInput.value = tempData.memo || "";
      }
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // -- 5. region-select.htmlë¡œ ì´ë™ ì „ ì„ì‹œ ì €ì¥ (ì´ì „ ë¡œì§ ê·¸ëŒ€ë¡œ) --
    addRegionBtn.onclick = () => {
      // í˜„ì¬ ìƒíƒœë¥¼ ì„ì‹œì €ì¥
      localStorage.setItem("tempPhotos", JSON.stringify(existingPhotos));
      localStorage.setItem("tempDistricts", JSON.stringify(selectedDistricts));
      localStorage.setItem("tempTitle", titleInput.value);
      localStorage.setItem("tempEmoji", currentEmoji);
      localStorage.setItem("tempMemo", memoInput.value);

      let url = `region-select.html?region=${encodeURIComponent(regionParam)}`;
      if (postIdParam) {
        url += `&selected=${encodeURIComponent(JSON.stringify(selectedDistricts))}&postId=${encodeURIComponent(postIdParam)}`;
      } else if (editIndex !== null) {
        // í¸ì§‘ ëª¨ë“œì¸ ê²½ìš°, edit ì¸ë±ìŠ¤ë„ í•¨ê»˜ ë„˜ê²¨ì¤Œ
        url += `&selected=${encodeURIComponent(JSON.stringify(selectedDistricts))}&edit=${encodeURIComponent(editIndex)}`;
      }
      location.href = url;
    };
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // -- 6. ì‚¬ì§„ ì—…ë¡œë“œ/ë Œë”/ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥ (ì´ì „ ë¡œì§ ê·¸ëŒ€ë¡œ) --
    function readFileAsDataURL(file) {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    }

    function renderPhotos(dataURLs) {
      photoPlaceholder.style.display = "none";
      photoSlider.style.display = "flex";
      photoSlider.innerHTML = "";
      dataURLs.forEach((dataUrl, idx) => {
        const card = document.createElement("div");
        card.className = "photo-card";

        const img = document.createElement("img");
        img.src = dataUrl;
        card.appendChild(img);

        const pageIndicator = document.createElement("div");
        pageIndicator.className = "page-indicator";
        pageIndicator.textContent = `${idx + 1}/${dataURLs.length}`;
        card.appendChild(pageIndicator);

        const replaceBtn = document.createElement("div");
        replaceBtn.className = "btn-replace";
        replaceBtn.textContent = "âœ ìˆ˜ì •";
        replaceBtn.onclick = () => {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = "image/*";
          input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const newDataUrl = await readFileAsDataURL(file);
            existingPhotos[idx] = newDataUrl;
            renderPhotos(existingPhotos);
          };
          input.click();
        };
        card.appendChild(replaceBtn);

        const deleteBtn = document.createElement("div");
        deleteBtn.className = "btn-delete";
        deleteBtn.textContent = "âœ•";
        deleteBtn.onclick = () => {
          existingPhotos.splice(idx, 1);
          if (existingPhotos.length === 0) {
            photoSlider.style.display = "none";
            photoPlaceholder.style.display = "flex";
          } else {
            renderPhotos(existingPhotos);
          }
        };
        card.appendChild(deleteBtn);

        photoSlider.appendChild(card);
      });
    }

    photoAddBtn.onclick = () => photoInput.click();
    photoInput.addEventListener("change", async function () {
      const files = Array.from(this.files);
      if (!files.length) return;

      const newDataUrls = [];
      for (const file of files) {
        const dataUrl = await readFileAsDataURL(file);
        newDataUrls.push(dataUrl);
      }
      existingPhotos = existingPhotos.concat(newDataUrls);
      renderPhotos(existingPhotos);
      this.value = "";
    });
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // -- 7. ì´ëª¨ì§€ ì„ íƒ ì´ë²¤íŠ¸ (ì´ì „ ë¡œì§ ê·¸ëŒ€ë¡œ) --
    emojiToggle.addEventListener("click", () => {
      emojiPicker.style.display = emojiPicker.style.display === "flex" ? "none" : "flex";
    });

    document.addEventListener("click", e => {
      if (!emojiPicker.contains(e.target) && !emojiToggle.contains(e.target)) {
        emojiPicker.style.display = "none";
      }
    });

    document.querySelectorAll(".emoji-option").forEach(option => {
      option.addEventListener("click", () => {
        currentEmoji = option.textContent;
        const span = document.createElement("span");
        span.className = "emoji-icon";
        span.textContent = currentEmoji;
        const existing = document.querySelector("#emoji-toggle .emoji-icon, #emoji-toggle img");
        if (existing) existing.replaceWith(span);
        emojiPicker.style.display = "none";
      });
    });
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // -- 8. â€œì •ì‹ ì €ì¥í•˜ê¸°â€ ê¸°ëŠ¥ (ì´ì „ ë¡œì§ ê·¸ëŒ€ë¡œ) --
    saveBtn.onclick = () => {
  const title = titleInput.value.trim();
  if (!title) {
    alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }
  if (!existingPhotos.length) {
    alert("ìµœì†Œ í•œ ì¥ì˜ ì‚¬ì§„ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
    return;
  }
  if (!currentEmoji) {
    alert("ì´ëª¨ì§€ë¥¼ í•˜ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }
  if (selectedDistricts.length === 0) {
    alert("ìµœì†Œ í•œ ê°œì˜ ì„¸ë¶€ ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  const now = new Date().toISOString();
  const postObj = {
    id: postIdParam || (new Date().getTime().toString()),
    region: regionParam,
    districts: [...selectedDistricts],
    title,
    photos: [...existingPhotos],
    emoji: currentEmoji,
    memo: memoInput.value.trim(),
    createdAt: postIdParam
      ? JSON.parse(localStorage.getItem("posts")).find(p => p.id === postIdParam).createdAt
      : now
  };

  // 1) postsì— ì €ì¥
  const allPosts = JSON.parse(localStorage.getItem("posts") || "[]");
  if (postIdParam) {
    const idx = allPosts.findIndex(p => p.id === postIdParam);
    if (idx !== -1) allPosts[idx] = postObj;
  } else {
    allPosts.push(postObj);
  }
  localStorage.setItem("posts", JSON.stringify(allPosts));

  // 2) â€œì„ì‹œì €ì¥ëœâ€ ìƒíƒœ(editIndex)ê°€ ìˆìœ¼ë©´ í•´ë‹¹ tempRecords í•­ëª©ì„ ì‚­ì œ
  if (editIndex !== null) {
    const existingTemp = JSON.parse(localStorage.getItem("tempRecords") || "[]");
    existingTemp.splice(editIndex, 1);               // editIndex ìœ„ì¹˜ í•­ëª© ì œê±°
    localStorage.setItem("tempRecords", JSON.stringify(existingTemp));
    localStorage.removeItem("editRecord");           // í¸ì§‘ìš© í‚¤ë„ ì œê±°
  }

  alert(postIdParam ? "ìˆ˜ì • ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤." : "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
  location.href = `../Detail/detail.html?region=${encodeURIComponent(regionParam)}`;
};

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 9. â€œì„ì‹œì €ì¥â€ ê¸°ëŠ¥ (ì „ì²´ ìƒíƒœ ì €ì¥ í˜¹ì€ ìˆ˜ì •)
tempSaveBtn.onclick = () => {
  // 1) í¼ì˜ ëª¨ë“  ì…ë ¥ê°’ ì½ì–´ì˜¤ê¸°
  const title = titleInput.value.trim();
  const tags = [...selectedDistricts];
  const emoji = currentEmoji;
  const photos = [...existingPhotos]; // ì‚¬ì§„ ì „ì²´ ë°°ì—´
  const memo = memoInput.value.trim();

  // 2) ì„ì‹œì €ì¥ìš© ê°ì²´ (ì „ì²´ ì…ë ¥ ì •ë³´)
  const tempRecord = {
    region: regionParam,    // ìƒìœ„ ì§€ì—­
    title: title || "",
    tags,                  // ì„¸ë¶€ ì§€ì—­ ë°°ì—´
    photos,                // ì‚¬ì§„ ë°ì´í„°URL ë°°ì—´
    emoji,                 // ì´ëª¨ì§€
    memo                   // ë©”ëª¨
  };

  // 3) localStorageì˜ "tempRecords" ë¶ˆëŸ¬ì˜¤ê¸°
  const existingTemp = JSON.parse(localStorage.getItem("tempRecords") || "[]");

  if (editIndex !== null) {
    // â€œí¸ì§‘ ëª¨ë“œâ€ë¼ë©´, í•´ë‹¹ ì¸ë±ìŠ¤ ë®ì–´ì“°ê¸°
    existingTemp[editIndex] = tempRecord;
  } else {
    // ìƒˆë¡œ ì €ì¥í•  ë•ŒëŠ” ë§¨ ë’¤ì— ì¶”ê°€
    existingTemp.push(tempRecord);
  }

  localStorage.setItem("tempRecords", JSON.stringify(existingTemp));

  // 4) edit ëª¨ë“œì˜€ë‹¤ë©´ editRecord ì œê±° (ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ê¶Œì¥)
  localStorage.removeItem("editRecord");

  // 5) ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ í›„ temp.htmlë¡œ ì´ë™
  alert(editIndex !== null ? "ì„ì‹œì €ì¥(ìˆ˜ì •)ë˜ì—ˆìŠµë‹ˆë‹¤." : "ì„ì‹œì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
  location.href = `../Detail/temp.html`;
};

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  </script>
</body>
</html>
