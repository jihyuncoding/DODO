<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>지역 선택</title>
  <link rel="stylesheet" href="region-select.css" />
</head>
<body>
  <div class="mobile-wrapper">
    <!-- 상단 바 -->
    <div class="top-bar">
      <img src="../images/iconoir_nav-arrow-left.png" class="back-icon" onclick="history.back()" />
      <span class="page-title" id="region-title">지역</span>
      <img src="../images/iconoir_search.svg" class="trash-icon" alt="검색" />
    </div>

    <!-- 고정 영역: 검색창 + 태그 + 리스트 헤더 -->
    <div class="fixed-content">
      <div class="search-bar">
        <input type="text" id="search" placeholder="지역 내 시/군/구를 검색해보세요" />
        <img src="../images/iconoir_search.svg" class="search-icon" />
      </div>
      <div class="selected-tags" id="selected-tags"></div>
      <div class="list-header">시/군/구</div>
    </div>

    <!-- 스크롤 되는 영역 -->
    <div class="scrollable-list">
      <ul class="region-list" id="region-list"></ul>
    </div>

    <!-- 하단 버튼 -->
    <div class="bottom-buttons">
      <button onclick="resetSelection()" class="reset-btn">선택 초기화</button>
      <button onclick="applySelection()" class="add-btn">지역 추가</button>
    </div>
  </div>

  <script>
    const regionData = {
     "서울": ["강남구", "강동구", "강북구", "강서구", "관악구", "광진구", "구로구", "금천구", "노원구", "도봉구", "동대문구", "동작구", "마포구", "서대문구", "서초구", "성동구", "성북구", "송파구", "양천구", "영등포구", "용산구", "은평구", "종로구", "중구", "중랑구"],
      "경기": ["가평군", "고양시", "과천시", "광명시", "광주시", "구리시", "군포시", "김포시", "남양주시", "동두천시", "부천시", "성남시", "수원시", "시흥시", "안산시", "안성시", "안양시", "양주시", "오산시", "용인시", "의왕시", "의정부시", "이천시", "파주시", "평택시", "포천시", "하남시", "화성시"],
      "부산": ["강서구", "금정구", "남구", "동구", "동래구", "부산진구", "북구", "사상구", "사하구", "서구", "수영구", "연제구", "영도구", "중구", "해운대구", "기장군"],
      "대구": ["남구", "달서구", "동구", "북구", "서구", "수성구", "중구", "달성군"],
      "인천": ["강화군", "계양구", "남동구", "동구", "부평구", "서구", "연수구", "옹진군", "중구", "미추홀구"],
      "광주": ["광산구", "남구", "동구", "북구", "서구"],
      "대전": ["대덕구", "동구", "서구", "유성구", "중구"],
      "울산": ["남구", "동구", "북구", "중구", "울주군"],
      "세종": ["세종시"],
      "강원": ["강릉시", "고성군", "동해시", "삼척시", "속초시", "양구군", "양양군", "영월군", "원주시", "인제군", "정선군", "철원군", "춘천시", "태백시", "평창군", "홍천군", "화천군", "횡성군"],
      "충북": ["괴산군", "단양군", "보은군", "영동군", "옥천군", "음성군", "제천시", "진천군", "청주시", "충주시", "증평군"],
      "충남": ["계룡시", "공주시", "논산시", "당진시", "보령시", "부여군", "서산시", "서천군", "아산시", "예산군", "천안시", "청양군", "태안군", "홍성군"],
      "전북": ["고창군", "군산시", "김제시", "남원시", "무주군", "부안군", "순창군", "완주군", "익산시", "임실군", "장수군", "전주시", "정읍시", "진안군"],
      "전남": ["강진군", "고흥군", "곡성군", "광양시", "구례군", "나주시", "담양군", "목포시", "무안군", "보성군", "순천시", "신안군", "여수시", "영광군", "영암군", "완도군", "장성군", "장흥군", "진도군", "함평군", "해남군", "화순군"],
      "경북": ["경산시", "경주시", "고령군", "구미시", "군위군", "김천시", "문경시", "봉화군", "상주시", "성주군", "안동시", "영덕군", "영양군", "영주시", "영천시", "예천군", "울릉군", "울진군", "의성군", "청도군", "청송군", "칠곡군", "포항시"],
      "경남": ["거제시", "거창군", "고성군", "김해시", "남해군", "밀양시", "사천시", "산청군", "양산시", "의령군", "진주시", "창녕군", "창원시", "통영시", "하동군", "함안군", "함양군", "합천군"],
      "제주": ["서귀포시", "제주시"]
    };

    // URL param에서 region, selected, postId 가져오기
    const params = new URLSearchParams(window.location.search);
    const regionParam = params.get("region") || "지역";
    const preSelected = params.get("selected") ? JSON.parse(params.get("selected")) : [];
    const postIdParam = params.get("postId");

    document.getElementById("region-title").textContent = regionParam;

    const districts = regionData[regionParam] || [];
    const regionListEl = document.getElementById("region-list");
    const searchInput = document.getElementById("search");
    const selectedTagsEl = document.getElementById("selected-tags");
    let selected = [...preSelected]; // 수정 모드에서 돌아올 때 미리 선택된 것

    function renderList(filter = "") {
      regionListEl.innerHTML = "";
      const filtered = districts.filter(d => d.includes(filter));
      filtered.forEach(district => {
        const li = document.createElement("li");
        li.textContent = district;
        if (selected.includes(district)) li.classList.add("selected");
        li.onclick = () => toggleSelection(district);
        regionListEl.appendChild(li);
      });
    }

    function toggleSelection(district) {
      if (selected.includes(district)) {
        selected = selected.filter(d => d !== district);
      } else {
        if (selected.length >= 4) {
          alert("최대 4개까지만 선택할 수 있습니다.");
          return;
        }
        selected.push(district);
      }
      renderList(searchInput.value);
      renderTags();
    }

    function renderTags() {
      selectedTagsEl.innerHTML = "";
      selected.forEach(d => {
        const tag = document.createElement("span");
        tag.className = "tag";
        tag.textContent = d;
        selectedTagsEl.appendChild(tag);
      });
    }

    function resetSelection() {
      selected = [];
      renderList(searchInput.value);
      renderTags();
    }

    function applySelection() {
    console.log(">> region-select: 최종 선택된 배열(selected) =", selected); // 디버깅
    localStorage.setItem("selectedDistricts", JSON.stringify(selected));
    console.log(">> region-select: localStorage에 저장된 selectedDistricts =", localStorage.getItem("selectedDistricts"));
    
    if (postIdParam) {
      location.href = `add.html?region=${encodeURIComponent(regionParam)}&postId=${encodeURIComponent(postIdParam)}`;
    } else {
      location.href = `add.html?region=${encodeURIComponent(regionParam)}`;
    }
  }

    searchInput.addEventListener("input", () => renderList(searchInput.value));
    renderList();
    renderTags();
  </script>
</body>
</html>
